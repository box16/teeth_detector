# 概要
本リポジトリでは、「下顎小臼歯」の画像を分類するためのCNNモデルを構築し、  
そのモデルを使ったシンプルなFlaskアプリを提供します。
  
* `create_model.py`  
4 つのクラス（フォルダ名）に分けられた画像データを読み込み、学習した CNN モデル（.h5形式）を生成します。
* `app.py`  
学習済みのモデルをロードし、ブラウザからアップロードされた画像を分類し、推論結果を表示します。

# 1. 動作環境・事前準備
Python 3.x がインストールされていることを確認してください（3.7以降推奨）。

## 必要ライブラリのインストール
下記コマンド例で、主要ライブラリをインストールしてください。

```bash
pip install -r requirement.txt
```

## 本リポジトリ内のファイル・フォルダ概要

```bash
├── app.py                  # Flask アプリ
├── create_model.py         # モデルの学習を行うスクリプト
├── model/
│   └── teeth_cnn_saved_model.h5   # 学習済みモデル(初回学習後に生成される)
├── sample/
│   ├── mandibular_left_1st_premolar/
│   ├── mandibular_left_2st_premolar/
│   ├── mandibular_right_1st_premolar/
│   └── mandibular_right_2st_premolar/
├── templates/
│   ├── index.html          # 画像アップロード画面
│   └── result.html         # 推論結果表示画面
└── requirement.txt
```

# 2. 学習データ（画像）の追加と再学習の手順
## 2-1. 学習用データの追加
フォルダ構成は以下のルールで配置します。画像は sample/ 以下の 4 クラス（フォルダ）に振り分けられている想定です。
```markdown
sample/
 ├── mandibular_left_1st_premolar/
 │   ├── xxx.jpg
 │   └── yyy.jpg
 ├── mandibular_left_2st_premolar/
 │   ├── aaa.jpg
 │   └── bbb.jpg
 ├── mandibular_right_1st_premolar/
 │   ├── ...
 └── mandibular_right_2st_premolar/
     ├── ...
```
各フォルダがクラスを示しています。新しい画像があれば、対応するクラスのフォルダに画像を追加してください。  

## 2-2. モデルの再学習
画像を追加・整理したあと、端末のターミナル（またはコマンドプロンプト）で本ディレクトリに移動し、
```bash
python create_model.py
```
を実行します。  
スクリプトが完了すると、`model/teeth_cnn_saved_model.h5` が更新され、新しく学習し直されたモデルが保存されます。

注意:  
create_model.py 内では、データを 80%（学習）と 20%（バリデーション）に分割して学習・評価しています。  
追加したデータの量やクオリティによって学習結果（精度）は異なります。  

# 3. Flask アプリの起動と動作確認
## 3-1. Flask アプリを起動
学習が終わった時点で、model/teeth_cnn_saved_model.h5 が最新になっています。
以下コマンドで Flask アプリを起動します:
```bash
python app.py
```

メッセージが表示され、デフォルトでは http://127.0.0.1:5000/ で立ち上がるので、ブラウザでアクセスしてください。  
## 3-2. 推論
ブラウザ上にアップロード用フォームが表示されます。  
そこに任意の歯の画像（下顎小臼歯）をアップロードし、「送信」または「分類」ボタンを押すと、モデルが推論を行います。  
推論結果として、
* 「下顎左第1小臼歯」
* 「下顎左第2小臼歯」
* 「下顎右第1小臼歯」
* 「下顎右第2小臼歯」   
のいずれかが表示されます。  
アップロードされた画像ファイルは、一時ファイルとして扱われ、推論後に自動的に削除されるので、サーバ側のディスクに蓄積されません。

# 4. モデルの精度を上げるためにできること
## 学習データを増やす
画像分類では、より多くのバリエーション（角度や明るさの異なる画像など）を用意することが重要です。  
特に医療画像では、患者ごとの差異や撮影条件の差を網羅できるほどデータを集めると精度向上が期待できます。  

## データの質を高める
アップロードされる画像がブレていないか、余分な背景が多くないかなどを確認し、質の高いデータを厳選します。  
アノテーション（ラベル付け）が誤っていないか再チェックすることも大切です。  

## データ拡張 (Data Augmentation) のパラメータ調整
`create_model.py` 内の `ImageDataGenerator` にある `rotation_range`, `width_shift_range`,   `height_shift_range`, `zoom_range` などを変更すると、データのバリエーションをより増やすことができます。  
ただし、拡張し過ぎると学習が不安定になったり、実際の画像とかけ離れた学習データになったりするので、適度に設定する必要があります。  

## CNN の構造を深くする or 転移学習を導入する
`create_model.py` 内では簡単な 2層の畳み込みを使っています。層を増やしたり、フィルター数を増やしたりすると表現力が上がる可能性があります。  
ただし、データが少ない場合は過学習に注意が必要です。  
あるいは、ResNet や VGG などの学習済みモデルを使った転移学習を試すと、大幅な精度向上が見込めます。  

## ハイパーパラメータ調整
学習率（optimizer='adam' などをもう少し詳細に設定）, バッチサイズ, エポック数などを変えてみる。  
early stopping の導入、学習率スケジューラの導入など。  

## クロスバリデーションの導入
より厳密にモデルの汎化性能を評価したい場合は、データを複数の分割に分けて学習・評価を繰り返す「クロスバリデーション」を導入すると良いです。  
ただし、フレームワーク的には `ImageDataGenerator` + フォルダ構成でのクロスバリデーションは工夫が必要です。  
